---
test_dev_pulp_content_url: "{{ dev_pulp_url }}/pulp/content/"

# Client certificates used to access ark.stackhpc.com repositories.
# They are trusted by the 'development' cert guard's CA.
test_client_cert: "{{ lookup('file', '../certs/ark.stackhpc.com/client-cert.pem') | trim }}"
test_client_key: "{{ lookup('file', '../certs/ark.stackhpc.com/client-key.pem') | trim }}"

# Common parameters for RPM package repositories.
test_pulp_repository_rpm_repo_common:
  client_cert: "{{ test_client_cert }}"
  client_key: "{{ test_client_key }}"
  # Download content on demand from Ark.
  policy: on_demand
  # Remove content that has been removed from the upstream mirror.
  sync_policy: mirror_complete
  state: present

test_pulp_repository_rpm_repos: >-
  {%- set test_repos = [] -%}
  {%- for repo in rpm_package_repos -%}
  {%- if repo.publish | default(true) -%}
  {%- set test_repo = {"name": repo.name ~ " (ark)", "url": test_dev_pulp_content_url ~ repo.base_path ~ repo.version} -%}
  {%- set _ = test_repos.append(test_pulp_repository_rpm_repo_common | combine(test_repo)) -%}
  {%- endif -%}
  {%- endfor -%}
  {{ test_repos }}

# Publication format is a subset of distribution.
test_pulp_publication_rpm: "{{ test_pulp_distribution_rpm }}"

# Common parameters for RPM package distributions.
test_pulp_distribution_rpm_common:
  state: present

test_pulp_distribution_rpm: >-
  {%- set test_dists = [] -%}
  {%- for repo in rpm_package_repos -%}
  {%- if repo.publish | default(true) -%}
  {%- set name = repo.distribution_name ~ repo.version ~ "-ark" -%}
  {%- set repo_name = repo.name ~ " (ark)" -%}
  {%- set base_path = repo.base_path ~ repo.version -%}
  {%- set test_dist = {"name": name, "repository": repo_name, "base_path": base_path, "short_name": repo.short_name} -%}
  {%- set _ = test_dists.append(test_pulp_distribution_rpm_common | combine(test_dist)) -%}
  {%- endif -%}
  {%- endfor -%}
  {{ test_dists }}

# Whether to skip existing RPM distributions. If true, new distributions will
# not be created for a publication if any distributions exist for the same
# publication.
test_pulp_distribution_rpm_skip_existing: true
